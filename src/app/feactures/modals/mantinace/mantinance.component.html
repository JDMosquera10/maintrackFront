<h2 mat-dialog-title>Gestión de Máquina</h2>

<mat-horizontal-stepper linear (selectedIndexChange)="changeStepper($event)">
  <!-- Paso 1: Datos -->
  <form [formGroup]="stepForm">
    <mat-step [stepControl]="datosForm" label="Datos">
      <div mat-dialog-content class="dialog-content">
        <div [formGroup]="datosForm" class="form-grid">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Máquina</mat-label>
            <mat-select formControlName="machine" required>
              <mat-option *ngIf="isLoadingMachines" disabled>Cargando...</mat-option>
              <mat-option *ngFor="let machine of machines" [value]="machine.id">
                {{ machine.model }} ({{ machine.serialNumber }})
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Tipo de mantenimiento</mat-label>
            <mat-select formControlName="type" required>
              <mat-option *ngIf="isLoadingTypes" disabled>Cargando tipos...</mat-option>
              <mat-option *ngFor="let type of maintenanceTypes" [value]="type.id">
                {{ type.name }}
              </mat-option>
              <mat-option *ngIf="maintenanceTypes.length === 0 && !isLoadingTypes" disabled>
                No hay tipos disponibles. Cree tipos en el módulo de gestión.
              </mat-option>
            </mat-select>
            <mat-hint *ngIf="isLoadingFirstState">Cargando estado inicial...</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Fecha</mat-label>
            <input matInput [matDatepicker]="picker1" formControlName="date" required>
            <mat-datepicker-toggle matIconSuffix [for]="picker1"></mat-datepicker-toggle>
            <mat-datepicker #picker1></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Horas de trabajo</mat-label>
            <input matInput type="number" formControlName="workHours" min="0">
          </mat-form-field>

          <mat-form-field appearance="outline" class="w-100" *ngIf="!data.istechenical">
            <mat-label>técnico</mat-label>
            <mat-select formControlName="technician" required>
              <mat-option *ngIf="isLoadingUsers" disabled>Cargando...</mat-option>
              <mat-option *ngFor="let technical of technicals" [value]="technical._id">
                {{ technical.firstName }} {{ technical.lastName }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="w-100" *ngIf="!data.istechenical">
            <mat-label>Observaciones</mat-label>
            <textarea matInput formControlName="observations" rows="1"></textarea>
          </mat-form-field>
        </div>

        <div *ngIf="data.istechenical" [formGroup]="datosForm" class="form-grid" class="containe-observation">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Observaciones</mat-label>
            <textarea matInput formControlName="observations" rows="2"></textarea>
          </mat-form-field>
        </div>
      </div>
      <mat-dialog-actions align="end">
        <div class="step-actions">
          <button mat-button matStepperNext [disabled]="!isDatosFormValid()" type="button">
            Siguiente
          </button>
          <button mat-button (click)="cancel()">Cancelar</button>
        </div>
      </mat-dialog-actions>
    </mat-step>

    <!-- Paso 2: Repuestos -->
    <mat-step [stepControl]="repuestosForm" label="Repuestos" style="height: 100%;">
      <div mat-dialog-content class="dialog-content">
        <div [formGroup]="repuestosForm" class="spare-parts-container">
          <div class="spare-parts-header">
            <h3>Repuestos y Materiales</h3>
            <p class="helper-text">Agregue los repuestos o materiales necesarios para este mantenimiento. Puede dejarlo vacío si no se requieren.</p>
          </div>

          <div class="spare-parts-input-section">
            <mat-form-field appearance="outline" class="spare-part-input">
              <mat-label>Nombre del repuesto</mat-label>
              <input 
                matInput 
                [(ngModel)]="newSparePartInput"
                (keydown.enter)="addSparePart()"
                placeholder="Ej: Filtro de aceite, Bujía, etc."
                [ngModelOptions]="{standalone: true}">
              <mat-hint>Presione Enter o haga clic en "Agregar"</mat-hint>
            </mat-form-field>
            <button 
              mat-raised-button 
              color="primary" 
              (click)="addSparePart()"
              [disabled]="!newSparePartInput || newSparePartInput.trim().length === 0"
              class="add-button">
              <mat-icon>add</mat-icon>
              Agregar
            </button>
          </div>

          <div class="spare-parts-list" *ngIf="spareParts.controls.length > 0">
            <h4>Repuestos agregados ({{ spareParts.controls.length }})</h4>
            <div class="chips-container">
              <mat-chip-set>
                <mat-chip 
                  *ngFor="let part of spareParts.controls; let i = index" 
                  [removable]="true"
                  (removed)="removeSparePart(i)"
                  class="spare-part-chip">
                  <mat-icon matChipAvatar>build</mat-icon>
                  {{ part.value }}
                </mat-chip>
              </mat-chip-set>
            </div>
          </div>

          <div class="empty-state" *ngIf="spareParts.controls.length === 0">
            <mat-icon>inventory_2</mat-icon>
            <p>No hay repuestos agregados</p>
            <p class="helper-text">Puede agregar repuestos usando el campo de arriba o continuar sin agregar ninguno.</p>
          </div>
        </div>
      </div>
      <mat-dialog-actions align="end">
        <div class="step-actions">
          <button mat-button matStepperPrevious type="button">Anterior</button>
          <button mat-button matStepperNext type="button">Siguiente</button>
          <button mat-button (click)="cancel()" type="button">Cancelar</button>
        </div>
      </mat-dialog-actions>
    </mat-step>

    <!-- Paso 3: Confirmar -->
    <mat-step label="Confirmar">
      <div mat-dialog-content class="dialog-content">
        <h3>Resumen</h3>
        <ul>
          <li><b>Máquina:</b> {{ getMachineModelById(datosForm.value.machine) }}</li>
          <li *ngIf="!data.istechenical"><b>Tipo:</b> {{ getMaintenanceTypeName(datosForm.value.type) }}
          </li>
          <li><b>Fecha:</b> {{ fromatDate(datosForm.value.date) }}</li>
          <li><b>Técnico:</b> {{ getNameTechnician(datosForm.value.technician) }}</li>
          <li><b>Observaciones:</b> {{ datosForm.value.observations }}</li>
          <li><b>Horas de trabajo:</b> {{ datosForm.value.workHours }}</li>
          <li><b>Repuestos:</b>
            <ul>
              <li *ngFor="let part of spareParts.controls">{{ part.value }}</li>
            </ul>
          </li>
        </ul>
      </div>
      <mat-dialog-actions align="end">
        <div class="step-actions">
          <button mat-button matStepperPrevious type="button">Anterior</button>
          <button mat-raised-button color="primary" (click)="submit()">Confirmar</button>
          <button mat-button type="button" (click)="cancel()">Cancelar</button>
        </div>
      </mat-dialog-actions>

    </mat-step>
  </form>
</mat-horizontal-stepper>